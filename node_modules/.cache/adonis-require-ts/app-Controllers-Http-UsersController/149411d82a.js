"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
const bcryptjs = require('bcryptjs');
const Env_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Env"));
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const Rol_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Rol"));
class UsersContUserler {
    async login({ request, response }) {
        const email = request.input('email');
        const password = request.input('password');
        try {
            const user = await User_1.default.findBy('email', email);
            if (!user) {
                return response.status(400).json({ state: false, message: "email invalido." });
            }
            const validPassword = bcryptjs.compareSync(password, user.password);
            if (!validPassword) {
                return response.status(400).json({ msj: 'Los datos de acceso no son correctos' });
            }
            const payload = {
                nombres: user.first_name,
                id: user.id,
                cedula: user.document_number,
            };
            const token = await this.generarToken(payload);
            const user_rol = await Rol_1.default.findBy('id', user.rol_id);
            if (!user_rol) {
                return response.status(400).json({ message: "ROL NOT FOUND" });
            }
            console.log(`token for test -> ${token}`);
            response.status(200).json({
                state: user.state,
                id: user.id,
                name: (user.first_name).concat(" ", user.second_name, " ", user.surname, " ", user.second_sur_name),
                role: user_rol.name,
                msg: "Ingreso exitoso",
            });
        }
        catch (error) {
            response.json({ state: false, message: "password or email invalid." });
        }
    }
    async generarToken(payload) {
        const opciones = { expiresIn: "30 mins" };
        return jsonwebtoken_1.default.sign(payload, Env_1.default.get('JWT_SECRET_KEY'), opciones);
    }
    async verificarToken(authorizationHeader) {
        let token = authorizationHeader.split(' ')[1];
        jsonwebtoken_1.default.verify(token, Env_1.default.get('JWT_SECRET_KEY'), (e) => {
            if (e) {
                console.log(`e token expirado -> ${e}`);
                throw new Error('Token expirado');
            }
        });
        return true;
    }
    async createUser({ request, response }) {
        try {
            const data_User = request.all();
            const UserObj = new User_1.default();
            UserObj.first_name = data_User.firstName;
            UserObj.second_name = data_User.secondName;
            UserObj.surname = data_User.surname;
            UserObj.second_sur_name = data_User.secondSurName;
            UserObj.type_document = data_User.typeDocument;
            UserObj.document_number = data_User.documentNumber;
            UserObj.email = data_User.email;
            const salt = bcryptjs.genSaltSync();
            UserObj.password = bcryptjs.hashSync(data_User.password, salt);
            UserObj.rol_id = (Math.floor(Math.random() * 2) + 1);
            UserObj.phone = data_User.phone;
            UserObj.state = true;
            await UserObj.save();
            return response.status(200).json({ "state": true, "message": "Estudiante creado exitosamente" });
        }
        catch (e) {
            console.log(`e -> ${e}`);
            return response.status(500).json({ "state": false, "message": "Fallo en la creaciÃ³n del estudiante" });
        }
    }
    async getUsers({ response }) {
        try {
            const L_User = await User_1.default.query().select('first_name', 'second_name', 'surname', 'second_sur_name', 'type_document', 'document_number', 'email', 'phone').where({});
            return response.status(200).json({ "state": true, "message": "Listado de estudiantes", "users": L_User });
        }
        catch (e) {
            console.log(`e-> ${e}`);
            return response.status(500).json({ "state": false, "message": "Fallo en el listado de estudiantes" });
        }
    }
    async updateUser({ request, response }) {
        const id_User = request.param('id_user');
        const data_User = request.all();
        try {
            await User_1.default.query().where('id', id_User).update({
                first_name: data_User.firstName,
                second_name: data_User.secondName,
                surname: data_User.surname,
                second_sur_name: data_User.secondSurName,
                type_document: data_User.typeDocument,
                document_number: data_User.documentNumber,
                email: data_User.email,
                password: data_User.password,
                rol_id: data_User.rolId,
                phone: data_User.phone,
                state: data_User.state
            });
            return response.status(200).json({
                "state": true, "message": "Se actualizo correctamente"
            });
        }
        catch (e) {
            return response.status(500).json({ "state": false, "message": "Error al actualizar" });
        }
    }
    async getUser({ request, response }) {
        const id = request.param('id_user');
        try {
            const user = await User_1.default.query().select('first_name', 'second_name', 'surname', 'second_sur_name', 'type_document', 'document_number', 'email', 'phone').where('id', id);
            return response.status(200).json(user);
        }
        catch (e) {
            return response.status(500).json({ "state": false, "message": "Error al consultar el detalle del usuario" });
        }
    }
    getPayload(authorizationHeader) {
        let token = authorizationHeader.split(' ')[1];
        const payload = jsonwebtoken_1.default.verify(token, Env_1.default.get("JWT_SECRET_KEY"), { complete: true }).payload;
        return payload;
    }
}
exports.default = UsersContUserler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXNlcnNDb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiVXNlcnNDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsaUZBQW1DO0FBQ25DLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtBQUNwQyxnRkFBc0M7QUFDdEMsZ0VBQThCO0FBQzlCLCtFQUFtQztBQUVuQyxNQUFxQixnQkFBZ0I7SUFDNUIsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQXVCO1FBQzNELE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDcEMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQTtRQUMxQyxJQUFJO1lBRUYsTUFBTSxJQUFJLEdBQUcsTUFBTSxjQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBQyxLQUFLLENBQUMsQ0FBQTtZQUM3QyxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUNULE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxDQUFDLENBQUE7YUFDOUU7WUFFRCxNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7WUFDbkUsSUFBSSxDQUFDLGFBQWEsRUFBRTtnQkFDbEIsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxzQ0FBc0MsRUFBRSxDQUFDLENBQUE7YUFDbEY7WUFFRCxNQUFNLE9BQU8sR0FBRTtnQkFDYixPQUFPLEVBQUUsSUFBSSxDQUFDLFVBQVU7Z0JBQ3hCLEVBQUUsRUFBRSxJQUFJLENB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LENBQUMsbUJBQTBCO1FBQzFDLElBQUksS0FBSyxHQUFHLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUM3QyxNQUFNLE9BQU8sR0FBRyxzQkFBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsYUFBRyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLEVBQUMsUUFBUSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUMsT0FBTyxDQUFBO1FBQ3RGLE9BQU8sT0FBTyxDQUFBO0lBQ2hCLENBQUM7Q0FHRjtBQTVJRCxtQ0E0SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEh0dHBDb250ZXh0Q29udHJhY3QgfSBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0h0dHBDb250ZXh0J1xuaW1wb3J0IFVzZXIgZnJvbSAnQXBwL01vZGVscy9Vc2VyJztcbmNvbnN0IGJjcnlwdGpzID0gcmVxdWlyZSgnYmNyeXB0anMnKVxuaW1wb3J0IEVudiBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0VudidcbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJ1xuaW1wb3J0IHJvbGVzIGZyb20gJ0FwcC9Nb2RlbHMvUm9sJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVXNlcnNDb250VXNlcmxlciB7XG4gIHB1YmxpYyBhc3luYyBsb2dpbih7IHJlcXVlc3QsIHJlc3BvbnNlIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBjb25zdCBlbWFpbCA9IHJlcXVlc3QuaW5wdXQoJ2VtYWlsJylcbiAgICBjb25zdCBwYXNzd29yZCA9IHJlcXVlc3QuaW5wdXQoJ3Bhc3N3b3JkJylcbiAgICB0cnkge1xuICAgICAgLy9jb25zdWx0YXIgc2kgZXhpc3RlIHVzdWFyaW8gY29uIGVzZSBjb3JyZW9cbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeSgnZW1haWwnLGVtYWlsKVxuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAwKS5qc29uKHtzdGF0ZTogZmFsc2UsIG1lc3NhZ2U6IFwiZW1haWwgaW52YWxpZG8uXCIgfSlcbiAgICAgIH1cblxuICAgICAgY29uc3QgdmFsaWRQYXNzd29yZCA9IGJjcnlwdGpzLmNvbXBhcmVTeW5jKHBhc3N3b3JkLCB1c2VyLnBhc3N3b3JkKVxuICAgICAgaWYgKCF2YWxpZFBhc3N3b3JkKSB7XG4gICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAwKS5qc29uKHsgbXNqOiAnTG9zIGRhdG9zIGRlIGFjY2VzbyBubyBzb24gY29ycmVjdG9zJyB9KVxuICAgICAgfVxuXG4gICAgICBjb25zdCBwYXlsb2FkID17XG4gICAgICAgIG5vbWJyZXM6IHVzZXIuZmlyc3RfbmFtZSxcbiAgICAgICAgaWQ6IHVzZXIuaWQsXG4gICAgICAgIGNlZHVsYTogdXNlci5kb2N1bWVudF9udW1iZXIsXG4gICAgICB9XG4gICAgICBjb25zdCB0b2tlbiA9IGF3YWl0IHRoaXMuZ2VuZXJhclRva2VuKHBheWxvYWQpXG5cblxuICAgICAgY29uc3QgdXNlcl9yb2wgPSBhd2FpdCByb2xlcy5maW5kQnkoJ2lkJyx1c2VyLnJvbF9pZClcbiAgICAgIGlmKCF1c2VyX3JvbCl7XG4gICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAwKS5qc29uKHttZXNzYWdlOiBcIlJPTCBOT1QgRk9VTkRcIn0pXG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUubG9nKGB0b2tlbiBmb3IgdGVzdCAtPiAke3Rva2VufWApXG4gICAgICByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgc3RhdGU6IHVzZXIuc3RhdGUsXG4gICAgICAgIGlkOiB1c2VyLmlkLFxuICAgICAgICBuYW1lOiAodXNlci5maXJzdF9uYW1lKS5jb25jYXQoXCIgXCIsdXNlci5zZWNvbmRfbmFtZSxcIiBcIix1c2VyLnN1cm5hbWUsXCIgXCIsdXNlci5zZWNvbmRfc3VyX25hbWUpLFxuICAgICAgICByb2xlOiB1c2VyX3JvbC5uYW1lLFxuICAgICAgICBtc2c6IFwiSW5ncmVzbyBleGl0b3NvXCIsXG4gICAgICB9KVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXNwb25zZS5qc29uKHtzdGF0ZTogZmFsc2UsIG1lc3NhZ2U6IFwicGFzc3dvcmQgb3IgZW1haWwgaW52YWxpZC5cIn0pXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZW5lcmFyVG9rZW4ocGF5bG9hZDogYW55KXtcbiAgICBjb25zdCBvcGNpb25lcyA9IHtleHBpcmVzSW46IFwiMzAgbWluc1wifVxuICAgIHJldHVybiBqd3Quc2lnbihwYXlsb2FkLCBFbnYuZ2V0KCdKV1RfU0VDUkVUX0tFWScpLCBvcGNpb25lcylcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB2ZXJpZmljYXJUb2tlbihhdXRob3JpemF0aW9uSGVhZGVyOiBzdHJpbmcpe1xuICAgIGxldCB0b2tlbiA9IGF1dGhvcml6YXRpb25IZWFkZXIuc3BsaXQoJyAnKVsxXVxuICAgIGp3dC52ZXJpZnkodG9rZW4sRW52LmdldCgnSldUX1NFQ1JFVF9LRVknKSwgKGUpID0+e1xuICAgICAgaWYoZSl7XG4gICAgICAgIGNvbnNvbGUubG9nKGBlIHRva2VuIGV4cGlyYWRvIC0+ICR7ZX1gKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Rva2VuIGV4cGlyYWRvJyk7XG4gICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gdHJ1ZVxuXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY3JlYXRlVXNlcih7cmVxdWVzdCwgcmVzcG9uc2V9OiBIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICB0cnl7XG4gICAgICBjb25zdCBkYXRhX1VzZXIgPSByZXF1ZXN0LmFsbCgpO1xuICAgICAgY29uc3QgVXNlck9iaiA9IG5ldyBVc2VyKCk7XG4gICAgICBVc2VyT2JqLmZpcnN0X25hbWUgPSBkYXRhX1VzZXIuZmlyc3ROYW1lXG4gICAgICBVc2VyT2JqLnNlY29uZF9uYW1lID0gZGF0YV9Vc2VyLnNlY29uZE5hbWVcbiAgICAgIFVzZXJPYmouc3VybmFtZSA9IGRhdGFfVXNlci5zdXJuYW1lXG4gICAgICBVc2VyT2JqLnNlY29uZF9zdXJfbmFtZSA9IGRhdGFfVXNlci5zZWNvbmRTdXJOYW1lXG4gICAgICBVc2VyT2JqLnR5cGVfZG9jdW1lbnQgPSBkYXRhX1VzZXIudHlwZURvY3VtZW50XG4gICAgICBVc2VyT2JqLmRvY3VtZW50X251bWJlciA9IGRhdGFfVXNlci5kb2N1bWVudE51bWJlclxuICAgICAgVXNlck9iai5lbWFpbCA9IGRhdGFfVXNlci5lbWFpbFxuXG4gICAgICAvL1NlIGVuY3JpcHRhIGxhIGNvbnRyYXNlbmEgY29uIGJjcnlwdGpzXG4gICAgICBjb25zdCBzYWx0ID0gYmNyeXB0anMuZ2VuU2FsdFN5bmMoKTtcbiAgICAgIFVzZXJPYmoucGFzc3dvcmQgPSAgYmNyeXB0anMuaGFzaFN5bmMoZGF0YV9Vc2VyLnBhc3N3b3JkLHNhbHQpXG5cbiAgICAgIC8vTm8gaGF5IGNyaXRlcmlvIHBhcmEgZWwgcm9sLCBzZXJhIGFsZWF0b3JpbywgZW50cmUgMTogYWRtaW4gbyAyOiBlc3R1ZGlhbnRlXG4gICAgICBVc2VyT2JqLnJvbF9pZCA9IChNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqMikrMSkgICAgICAvL3JhbmRpbnQoMSwyKVxuICAgICAgVXNlck9iai5waG9uZSA9IGRhdGFfVXNlci5waG9uZVxuICAgICAgVXNlck9iai5zdGF0ZSA9IHRydWUgICAgICAvL1BvciBkZWZhdWx0IGxvcyB1c3VhcmlvcyBjcmVhZG9zIGVzdGFuIGhhYmlsaXRhZG9zIHBhcmEgdXNhcnNlXG5cbiAgICAgIGF3YWl0IFVzZXJPYmouc2F2ZSgpO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cygyMDApLmpzb24oe1wic3RhdGVcIjogdHJ1ZSxcIm1lc3NhZ2VcIjogXCJFc3R1ZGlhbnRlIGNyZWFkbyBleGl0b3NhbWVudGVcIn0pXG4gICAgfWNhdGNoKGUpe1xuICAgICAgY29uc29sZS5sb2coYGUgLT4gJHtlfWApXG4gICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7XCJzdGF0ZVwiOiBmYWxzZSwgXCJtZXNzYWdlXCI6IFwiRmFsbG8gZW4gbGEgY3JlYWNpw7NuIGRlbCBlc3R1ZGlhbnRlXCJ9KVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRVc2Vycyh7cmVzcG9uc2V9OiBIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICB0cnl7XG4gICAgICBjb25zdCBMX1VzZXIgPSBhd2FpdCBVc2VyLnF1ZXJ5KCkuc2VsZWN0KCdmaXJzdF9uYW1lJywnc2Vjb25kX25hbWUnLCdzdXJuYW1lJywnc2Vjb25kX3N1cl9uYW1lJywndHlwZV9kb2N1bWVudCcsJ2RvY3VtZW50X251bWJlcicsJ2VtYWlsJywncGhvbmUnKS53aGVyZSh7fSk7XG4gICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7XCJzdGF0ZVwiOiB0cnVlLFwibWVzc2FnZVwiOiBcIkxpc3RhZG8gZGUgZXN0dWRpYW50ZXNcIiwgXCJ1c2Vyc1wiOiBMX1VzZXJ9KVxuICAgIH1jYXRjaChlKXtcbiAgICAgIGNvbnNvbGUubG9nKGBlLT4gJHtlfWApXG4gICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7XCJzdGF0ZVwiOiBmYWxzZSwgXCJtZXNzYWdlXCI6IFwiRmFsbG8gZW4gZWwgbGlzdGFkbyBkZSBlc3R1ZGlhbnRlc1wifSlcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlVXNlcih7cmVxdWVzdCxyZXNwb25zZX06IEh0dHBDb250ZXh0Q29udHJhY3Qpe1xuICAgIGNvbnN0IGlkX1VzZXI9cmVxdWVzdC5wYXJhbSgnaWRfdXNlcicpO1xuICAgIGNvbnN0IGRhdGFfVXNlciA9IHJlcXVlc3QuYWxsKCk7XG4gICAgdHJ5e1xuICAgICAgYXdhaXQgVXNlci5xdWVyeSgpLndoZXJlKCdpZCcsaWRfVXNlcikudXBkYXRlKHtcbiAgICAgICAgZmlyc3RfbmFtZTogZGF0YV9Vc2VyLmZpcnN0TmFtZSxcbiAgICAgICAgc2Vjb25kX25hbWU6IGRhdGFfVXNlci5zZWNvbmROYW1lLFxuICAgICAgICBzdXJuYW1lOiBkYXRhX1VzZXIuc3VybmFtZSxcbiAgICAgICAgc2Vjb25kX3N1cl9uYW1lOiBkYXRhX1VzZXIuc2Vjb25kU3VyTmFtZSxcbiAgICAgICAgdHlwZV9kb2N1bWVudDogZGF0YV9Vc2VyLnR5cGVEb2N1bWVudCxcbiAgICAgICAgZG9jdW1lbnRfbnVtYmVyOiBkYXRhX1VzZXIuZG9jdW1lbnROdW1iZXIsXG4gICAgICAgIGVtYWlsOiBkYXRhX1VzZXIuZW1haWwsXG4gICAgICAgIHBhc3N3b3JkOiBkYXRhX1VzZXIucGFzc3dvcmQsXG4gICAgICAgIHJvbF9pZDogZGF0YV9Vc2VyLnJvbElkLFxuICAgICAgICBwaG9uZTogZGF0YV9Vc2VyLnBob25lLFxuICAgICAgICBzdGF0ZTogZGF0YV9Vc2VyLnN0YXRlXG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cygyMDApLmpzb24oIHtcbiAgICAgIFwic3RhdGVcIjogdHJ1ZSwgXCJtZXNzYWdlXCI6IFwiU2UgYWN0dWFsaXpvIGNvcnJlY3RhbWVudGVcIn0pXG4gICAgfWNhdGNoKGUpe1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe1wic3RhdGVcIjogZmFsc2UsXCJtZXNzYWdlXCI6IFwiRXJyb3IgYWwgYWN0dWFsaXphclwifSlcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0VXNlcih7cmVxdWVzdCxyZXNwb25zZX06IEh0dHBDb250ZXh0Q29udHJhY3Qpe1xuICAgIGNvbnN0IGlkID0gcmVxdWVzdC5wYXJhbSgnaWRfdXNlcicpXG4gICAgdHJ5e1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIucXVlcnkoKS5zZWxlY3QoJ2ZpcnN0X25hbWUnLCdzZWNvbmRfbmFtZScsJ3N1cm5hbWUnLCdzZWNvbmRfc3VyX25hbWUnLCd0eXBlX2RvY3VtZW50JywnZG9jdW1lbnRfbnVtYmVyJywnZW1haWwnLCdwaG9uZScpLndoZXJlKCdpZCcsaWQpXG4gICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih1c2VyKVxuICAgIH1jYXRjaChlKXtcbiAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNTAwKS5qc29uKHtcInN0YXRlXCI6IGZhbHNlLFwibWVzc2FnZVwiOiBcIkVycm9yIGFsIGNvbnN1bHRhciBlbCBkZXRhbGxlIGRlbCB1c3VhcmlvXCJ9KVxuICAgIH1cbiAgfVxuXG5cbiAgcHVibGljIGdldFBheWxvYWQoYXV0aG9yaXphdGlvbkhlYWRlcjpzdHJpbmcpIHtcbiAgICBsZXQgdG9rZW4gPSBhdXRob3JpemF0aW9uSGVhZGVyLnNwbGl0KCcgJylbMV1cbiAgICBjb25zdCBwYXlsb2FkID0gand0LnZlcmlmeSh0b2tlbiwgRW52LmdldChcIkpXVF9TRUNSRVRfS0VZXCIpLCB7Y29tcGxldGU6IHRydWV9KS5wYXlsb2FkXG4gICAgcmV0dXJuIHBheWxvYWRcbiAgfVxuXG5cbn1cbiJdfQ==